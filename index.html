

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ventilator Tank Calculator</title>
<style>
  /* ... (your original CSS remains unchanged) ... */
</style>
</head>
<body>
<div class="container">
  <h1>Ventilator Tank Calculator</h1>

  <label>Minute Ventilation (L/min)</label>
  <input type="number" id="minuteVentilation" placeholder="Enter value" step="0.01" />

  <label>Leak (L/min)</label>
  <input type="number" id="leak" placeholder="Enter value" step="0.01" />

  <label>Bias Flow (L/min)</label>
  <input type="number" id="biasFlow" placeholder="Enter value" step="0.01" />

  <label>Hours to Ventilate</label>
  <input type="number" id="hours" placeholder="Enter value" step="0.01" />

  <!-- ✅ NEW FIO2 INPUT FIELD -->
  <label>FiO₂ (%)</label>
  <input type="number" id="fio2" placeholder="Enter value (20.9–79.1)" step="0.1" min="20.9" max="79.1" />

  <div style="display:flex; justify-content: space-between;">
    <button onclick="calculate()">Calculate</button>
    <button onclick="resetForm()">Reset</button>
  </div>

  <!-- ... (unchanged results + custom tanks + debug sections) ... -->

<script>
  function logDebug(message) {
    const debugBox = document.getElementById("debug");
    if (debugBox) debugBox.textContent += message + "\n";
    console.log(message);
  }

  const tankSizes = [
    { name: "D", value: 425 },
    { name: "DJ", value: 640 },
    { name: "E", value: 680 },
    { name: "M", value: 1738 },
    { name: "M/MM/M122", value: 3455 },
    { name: "H/K", value: 7080 },
  ];

  let selectedTanks = [];
  let totalLitresRequired = 0;

  window.calculate = function () {
    logDebug("=== Calculate button clicked ===");

    try {
      const minuteVentilation =
        parseFloat(document.getElementById("minuteVentilation").value) || 0;
      const leak = parseFloat(document.getElementById("leak").value) || 0;
      const biasFlow = parseFloat(document.getElementById("biasFlow").value) || 0;
      const hours = parseFloat(document.getElementById("hours").value) || 0;
      const fio2 = parseFloat(document.getElementById("fio2").value) || 20.9;

      logDebug("Inputs received:");
      logDebug("Minute Ventilation: " + minuteVentilation);
      logDebug("Leak: " + leak);
      logDebug("Bias Flow: " + biasFlow);
      logDebug("Hours: " + hours);
      logDebug("FiO2: " + fio2);

      if (fio2 < 20.9 || fio2 > 79.1) {
        alert("FiO₂ must be between 20.9 and 79.1%");
        return;
      }

      const baseFlow = minuteVentilation + leak + biasFlow;
      const multiplier = (fio2 - 20.9) / 79.1;
      const litresPerMinute = multiplier * baseFlow;

      logDebug("Base Flow: " + baseFlow.toFixed(2));
      logDebug("Multiplier: " + multiplier.toFixed(4));
      logDebug("Adjusted Litres per Minute = " + litresPerMinute.toFixed(2));

      const totalLitres = litresPerMinute * hours * 60;
      logDebug("Total Litres = " + totalLitres);

      let selectedTank = "None – too large";
      let selectedTankValue = 0;
      for (let i = 0; i < tankSizes.length; i++) {
        if (totalLitres <= tankSizes[i].value) {
          selectedTank = tankSizes[i].name;
          selectedTankValue = tankSizes[i].value;
          break;
        }
      }

      let extraLitres = 0;
      let alertMessage = "";
      if (selectedTankValue > 0) {
        extraLitres = selectedTankValue - totalLitres;
      } else {
        alertMessage = "WARNING: Total litres exceed all available tanks!";
      }

      let twoTanksOption = "";
      if (selectedTankValue > 0) {
        const selectedIndex = tankSizes.findIndex(t => t.name === selectedTank);
        if (selectedIndex > 0) {
          for (let i = 0; i < selectedIndex; i++) {
            if (tankSizes[i].value * 2 >= totalLitres) {
              const spare = tankSizes[i].value * 2 - totalLitres;
              twoTanksOption = `Two tanks option: Two ${tankSizes[i].name} tanks can supply the volume with ${spare.toFixed(2)} L to spare.`;
              break;
            }
          }
        }
      }

      logDebug("Selected Tank = " + selectedTank);
      logDebug("Extra Litres Left = " + extraLitres.toFixed(2));
      if (alertMessage) logDebug(alertMessage);
      if (twoTanksOption) logDebug(twoTanksOption);

      document.getElementById("litresPerMinute").innerText = litresPerMinute.toFixed(2);
      document.getElementById("totalLitres").innerText = totalLitres.toFixed(2);
      document.getElementById("tankSize").innerText = selectedTank;
      document.getElementById("extraLitres").innerText = extraLitres.toFixed(2);
      document.getElementById("alertMessage").innerText = alertMessage;
      document.getElementById("twoTanksOption").innerText = twoTanksOption;
      document.getElementById("results").style.display = "block";

      selectedTanks = [];
      const checkboxes = document.querySelectorAll("#tankList input[type='checkbox']");
      checkboxes.forEach(cb => (cb.checked = false));
      updateSelectedTanksDisplay();

      totalLitresRequired = totalLitres;
      const customTanksDiv = document.getElementById("customTanksSelection");
      customTanksDiv.style.display = totalLitres > 0 ? "block" : "none";
    } catch (error) {
      logDebug("ERROR: " + error.message);
    }
  };

  window.resetForm = function () {
    document.getElementById("minuteVentilation").value = "";
    document.getElementById("leak").value = "";
    document.getElementById("biasFlow").value = "";
    document.getElementById("hours").value = "";
    document.getElementById("fio2").value = "";

    document.getElementById("results").style.display = "none";
    document.getElementById("litresPerMinute").innerText = "";
    document.getElementById("totalLitres").innerText = "";
    document.getElementById("tankSize").innerText = "";
    document.getElementById("extraLitres").innerText = "";
    document.getElementById("alertMessage").innerText = "";
    document.getElementById("twoTanksOption").innerText = "";

    document.getElementById("debug").textContent = "Debug Output:\n";

    selectedTanks = [];
    const checkboxes = document.querySelectorAll("#tankList input[type='checkbox']");
    checkboxes.forEach(cb => (cb.checked = false));
    updateSelectedTanksDisplay();

    document.getElementById("combinedLitres").innerText = "0";
    document.getElementById("volumeCheckMessage").innerText = "";
    document.getElementById("customTanksSelection").style.display = "none";
  };

  // ... (your custom tank checkbox generation and helper functions remain unchanged)

</script>
</body>
</html>



