<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ventilator Tank Calculator</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: #f5f5f5;
  }
  .container {
    max-width: 500px;
    margin: auto;
    padding: 20px;
    background: #fff;
    min-height: 100vh;
    box-sizing: border-box;
  }
  h1 {
    font-size: 1.8em;
    margin-bottom: 10px;
    text-align: center;
  }
  label {
    display: block;
    margin-top: 15px;
    font-weight: bold;
  }
  input[type="number"] {
    width: 100%;
    padding: 12px;
    font-size: 1em;
    margin-top: 5px;
    box-sizing: border-box;
  }
  button {
    margin-top: 20px;
    padding: 15px;
    width: 48%;
    font-size: 1.1em;
    border: none;
    border-radius: 8px;
    cursor: pointer;
  }
  button:first-of-type {
    background: #007BFF;
    color: #fff;
  }
  button:first-of-type:active {
    background: #0056b3;
  }
  button:last-of-type {
    background: #6c757d;
    color: #fff;
    margin-left: 4%;
  }
  button:last-of-type:active {
    background: #5a6268;
  }
  #results {
    margin-top: 25px;
    background: #e9ecef;
    padding: 15px;
    border-radius: 8px;
    display: none;
    font-size: 1em;
  }
  #debug {
    margin-top: 20px;
    background: #222;
    color: #0f0;
    padding: 15px;
    font-family: monospace;
    white-space: pre-wrap;
    max-height: 200px;
    overflow-y: auto;
    border-radius: 8px;
    font-size: 0.9em;
  }
  /* Custom tanks selection */
  #customTanksSelection {
    margin-top: 20px;
    display: none;
    background: #e0e7ff;
    padding: 15px;
    border-radius: 8px;
  }
  #customTanksSelection h3 {
    margin-top: 0;
  }
  @media (max-width: 400px) {
    h1 {
      font-size: 1.5em;
    }
    input,
    button {
      font-size: 1em;
      padding: 10px;
    }
    #results,
    #debug {
      font-size: 0.85em;
      padding: 10px;
    }
    button {
      width: 100%;
      margin-left: 0;
      margin-top: 10px;
    }
  }
</style>
</head>
<body>
<div class="container">
  <h1>Ventilator Tank Calculator</h1>

  <label>Minute Ventilation (L/min)</label>
  <input type="number" id="minuteVentilation" placeholder="Enter value" step="0.01" min="0" />

  <label>Leak (L/min)</label>
  <input type="number" id="leak" placeholder="Enter value" step="0.01" min="0" />

  <label>Bias Flow (L/min)</label>
  <input type="number" id="biasFlow" placeholder="Enter value" step="0.01" min="0" />

  <label>Hours to Ventilate</label>
  <input type="number" id="hours" placeholder="Enter value" step="0.01" min="0" />

  <label>FiO₂ (%)</label>
  <input type="number" id="fio2" placeholder="20.9 to 79.1" step="0.1" min="20.9" max="79.1" />

  <div style="display:flex; justify-content: space-between;">
    <button onclick="calculate()">Calculate</button>
    <button onclick="resetForm()">Reset</button>
  </div>

  <div id="results">
    <h2>Results</h2>
    <p><strong>Adjusted Litres per Minute:</strong> <span id="litresPerMinute"></span> L/min</p>
    <p><strong>Total Litres:</strong> <span id="totalLitres"></span> L</p>
    <p><strong>Recommended Tank:</strong> <span id="tankSize"></span></p>
    <p><strong>Extra Litres Left in Tank:</strong> <span id="extraLitres"></span> L</p>
    <p id="alertMessage" style="color:red; font-weight:bold;"></p>
    <p id="twoTanksOption" style="font-weight:bold;"></p>
  </div>

  <div id="customTanksSelection">
    <h3>Select Tanks (up to 3)</h3>
    <p>Enter tank name (e.g. D, DJ, E, M, M/MM/M122, H/K):</p>
    <input
      type="text"
      id="tankNameInput"
      placeholder="Enter tank name"
      style="padding: 8px; font-size: 1em; width: 70%;"
    />
    <button onclick="addTank()">Select</button>

    <div id="selectedTanksDisplay" style="margin-top: 15px;">
      <strong>Selected Tanks:</strong> <span id="selectedTanksList">None</span>
    </div>
    <div style="margin-top: 10px;">
      <strong>Total Combined Litres:</strong> <span id="combinedLitres">0</span> L
    </div>
    <div id="volumeCheckMessage" style="margin-top: 10px; font-weight: bold;"></div>
  </div>

  <div id="debug">
    Debug Output:
  </div>
</div>

<script>
  function logDebug(message) {
    const debugBox = document.getElementById("debug");
    if (debugBox) debugBox.textContent += message + "\n";
    console.log(message);
  }

  // Tank sizes - keep in sync with rest of code
  const tankSizes = [
    { name: "D", value: 425 },
    { name: "DJ", value: 640 },
    { name: "E", value: 680 },
    { name: "M", value: 1738 },
    { name: "M/MM/M122", value: 3455 },
    { name: "H/K", value: 7080 },
  ];

  // Store selected tanks here for custom input
  let selectedTanks = [];
  let totalLitresRequired = 0;

  window.calculate = function () {
    logDebug("=== Calculate button clicked ===");

    try {
      const minuteVentilation =
        parseFloat(document.getElementById("minuteVentilation").value) || 0;
      const leak = parseFloat(document.getElementById("leak").value) || 0;
      const biasFlow = parseFloat(document.getElementById("biasFlow").value) || 0;
      const hours = parseFloat(document.getElementById("hours").value) || 0;
      let fio2 = parseFloat(document.getElementById("fio2").value);

      logDebug("Inputs received:");
      logDebug("Minute Ventilation: " + minuteVentilation);
      logDebug("Leak: " + leak);
      logDebug("Bias Flow: " + biasFlow);
      logDebug("Hours: " + hours);
      logDebug("FiO2: " + fio2);

      if (isNaN(fio2) || fio2 < 20.9 || fio2 > 79.1) {
        alert("FiO₂ must be between 20.9 and 79.1");
        return;
      }

      // Calculate adjusted litres per minute based on FiO2 formula
      const baseFlow = minuteVentilation + leak + biasFlow;
      const adjustedFlow = ((fio2 - 20.9) / 79.1) * baseFlow;

      logDebug("Base Flow (MinuteVentilation + Leak + BiasFlow): " + baseFlow);
      logDebug("Adjusted Flow (after FiO2 factor): " + adjustedFlow);

      // Total litres needed
      const totalLitres = adjustedFlow * hours * 60; // hours * 60 for minutes

      logDebug("Total Litres = " + totalLitres);

      // Recommended tank = first tank not exceeded
      let selectedTank = "None – too large";
      let selectedTankValue = 0;
      for (let i = 0; i < tankSizes.length; i++) {
        if (totalLitres <= tankSizes[i].value) {
          selectedTank = tankSizes[i].name;
          selectedTankValue = tankSizes[i].value;
          break;
        }
      }

      // Extra litres left in tank
      let extraLitres = 0;
      let alertMessage = "";
      if (selectedTankValue > 0) {
        extraLitres = selectedTankValue - totalLitres;
      } else {
        extraLitres = 0; // Show 0 when no tank fits
        alertMessage = "WARNING: Total litres exceed all available tanks!";
      }

      // Two smaller tanks option
      let twoTanksOption = "";
      if (selectedTankValue > 0) {
        // Find two identical tanks smaller than the selected tank that can supply totalLitres
        const selectedIndex = tankSizes.findIndex(
          (t) => t.name === selectedTank
        );
        if (selectedIndex > 0) {
          for (let i = 0; i < selectedIndex; i++) {
            if (tankSizes[i].value * 2 >= totalLitres) {
              const spare = tankSizes[i].value * 2 - totalLitres;
              twoTanksOption = `Two tanks option: Two ${tankSizes[i].name} tanks can supply the volume with ${spare.toFixed(
                2
              )} L to spare.`;
              break;
            }
          }
        }
      }

      logDebug("Selected Tank = " + selectedTank);
      logDebug("Extra Litres Left = " + extraLitres);
      if (alertMessage) logDebug(alertMessage);
      if (twoTanksOption) logDebug(twoTanksOption);

      const resultsDiv = document.getElementById("results");
      if (resultsDiv) {
        document.getElementById("litresPerMinute").innerText = adjustedFlow.toFixed(2);
        document.getElementById("totalLitres").innerText = totalLitres.toFixed(2);
        document.getElementById("tankSize").innerText = selectedTank;
        document.getElementById("extraLitres").innerText = extraLitres.toFixed(2);
        document.getElementById("alertMessage").innerText = alertMessage;
        document.getElementById("twoTanksOption").innerText = twoTanksOption;
        resultsDiv.style.display = "block";
      }

      // Reset custom tank selection inputs on every calculation
      selectedTanks = [];
      updateSelectedTanksDisplay();
      document.getElementById("combinedLitres").innerText = "0";
      document.getElementById("volumeCheckMessage").innerText = "";

      // Show custom tank selection only if totalLitres > 0
      totalLitresRequired = totalLitres;
      const customTanksDiv = document.getElementById("customTanksSelection");
      if (totalLitres > 0) {
        customTanksDiv.style.display = "block";
      } else {
        customTanksDiv.style.display = "none";
      }
    } catch (error) {
      logDebug("ERROR: " + error.message);
    }
  };

  window.resetForm = function () {
    document.getElementById("minuteVentilation").value = "";
    document.getElementById("leak").value = "";
    document.getElementById("biasFlow").value = "";
    document.getElementById("hours").value = "";
    document.getElementById("fio2").value = "";

    document.getElementById("results").style.display = "none";
    document.getElementById("litresPerMinute").innerText = "";
    document.getElementById("totalLitres").innerText = "";
    document.getElementById("tankSize").innerText = "";
    document.getElementById("extraLitres").innerText = "";
    document.getElementById("alertMessage").innerText = "";
    document.getElementById("twoTanksOption").innerText = "";

    document.getElementById("debug").textContent = "Debug Output:\n";

    // Reset custom tanks input
    selectedTanks = [];
    updateSelectedTanksDisplay();
    document.getElementById("combinedLitres").innerText = "0";
    document.getElementById("volumeCheckMessage").innerText = "";
    document.getElementById("customTanksSelection").style.display = "none";
  };

  function addTank() {
    const input = document.getElementById("tankNameInput");
    const tankName = input.value.trim();
    const messageDiv = document.getElementById("volumeCheckMessage");

    // Find tank by name (case-insensitive)
    const tank = tankSizes.find(
      (t) => t.name.toLowerCase() === tankName.toLowerCase()
    );

    if (!tank) {
      alert("Tank name not recognized. Please enter a valid tank name.");
      input.value = "";
      return;
    }

    if (selectedTanks.length >= 3) {
      alert("You can select up to 3 tanks only.");
      input.value = "";
      return;
    }

    // Add tank to selectedTanks
    selectedTanks.push(tank);
    input.value = "";

    updateSelectedTanksDisplay();

    // Check combined volume against total required
    const combinedVolume = selectedTanks.reduce(
      (sum, tank) => sum + tank.value,
      0
    );
    const combinedLitresSpan = document.getElementById("combinedLitres");
    combinedLitresSpan.innerText = combinedVolume.toFixed(2);

    if (combinedVolume >= totalLitresRequired)




